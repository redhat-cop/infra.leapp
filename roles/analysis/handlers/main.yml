---
# handlers file for analysis

# Registers with the satellite key used before the analysis when the content view
# for analysis is different from what the system uses by default.
# This is triggered by defining leapp_satellite_activation_key_pre_leapp variable (see README.md).
# Note: Handlers don't support include_role directly, so we use include_tasks instead.
- name: Register with pre-analysis Satellite activation key
  ansible.builtin.include_tasks:
    file: register-satellite.yml
  vars:
    __satellite_activation_key: "{{ leapp_satellite_activation_key_pre_leapp }}"
  when:
    - leapp_upgrade_type == 'satellite'
    - leapp_satellite_activation_key_pre_leapp | default('') | length > 0

# Similar to the above, but for RHEL 6.
# Note: RHEL 6 does not support the rhc role - using subscription-manager directly.
- name: Register with pre-analysis Satellite activation key (RHEL 6)
  ansible.builtin.shell: >
    export PATH={{ leapp_os_path }};
    subscription-manager register
    --org="{{ leapp_satellite_organization }}"
    --activationkey="{{ leapp_satellite_activation_key_pre_leapp }}"
    --force
  register: sub_man_reg
  changed_when: true
  failed_when: false
  when:
    - leapp_upgrade_type == 'satellite'
    - leapp_satellite_organization | default('') | length > 0
    - leapp_satellite_activation_key_pre_leapp | default('') | length > 0

- name: Remove lynx package
  ansible.builtin.package:
    name: lynx
    state: absent

# Keep this last so it's easy to find in the job output.
- name: Display inhibitors
  ansible.builtin.debug:
    var: results_inhibitors.stdout_lines
  when:
    - results_inhibitors is defined
    - results_inhibitors.stdout_lines | length > 0
  listen: Preupgrade analysis report is done

- name: Display errors
  ansible.builtin.debug:
    var: results_errors.stdout_lines
  when:
    - results_errors is defined
    - results_errors.stdout_lines | length > 0
  listen: Preupgrade analysis report is done

- name: Preupgrade analysis report is done
  ansible.builtin.debug:
    msg: >-
      The preupgrade analysis report generation is now complete.
      {{ 'WARNING: Inhibitors' if upgrade_inhibited else 'SUCCESS: No inhibitors' }} found.
      Review the tasks above or the result file at {{ leapp_result_filename }}.

...

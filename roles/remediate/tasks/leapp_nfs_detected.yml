---
- name: leapp_nfs_detected | Continue when leapp report is missing
  ansible.builtin.debug:
    msg: "Leapp report missing. Skipping this task."
  when: leapp_report_missing | default(false)

- name: leapp_nfs_detected | Disable NFS temporarily for the upgrade
  vars:
    leapp_inhibitor_keys:
      - 9881b25faceeeaa7a6478bcdac29afd7f6baaaed
    leapp_inhibitor_title: Use of NFS detected. Upgrade can't proceed
    leapp_report_entries: "{{ leapp_report_data.entries | default([]) }}"
    leapp_inhibitor_entries_by_key: "{{ leapp_report_entries
      | selectattr('key', 'defined')
      | selectattr('key', 'in', leapp_inhibitor_keys)
      | list }}"
    leapp_inhibitor_entries_by_title: "{{ leapp_report_entries
      | selectattr('title', 'defined')
      | selectattr('title', 'match', '(?i)' ~ leapp_inhibitor_title)
      | list }}"
    leapp_inhibitor_entries: "{{ leapp_inhibitor_entries_by_key
      if leapp_inhibitor_entries_by_key | length > 0
      else leapp_inhibitor_entries_by_title }}"
    leapp_inhibitor_summary: "{{ leapp_inhibitor_entries
      | selectattr('summary', 'defined')
      | rejectattr('summary', 'eq', '')
      | map(attribute='summary')
      | first | default('') }}"
    split_summary: "{{ leapp_inhibitor_summary.split('- NFS')[1:]
      | map('regex_replace', '^[\\s\\n]+', '- NFS ')
      | list }}"
    fstab_entries: "{{ split_summary
      | select('search', '- NFS shares found in /etc/fstab:')
      | map('regex_replace', '^.*- NFS shares found in /etc/fstab:\\s*', '')
      | map('regex_findall', '- ([^ ]+)') | flatten
      | list }}"
    nfs_mounts: "{{ split_summary
      | select('search', '- NFS shares currently mounted:')
      | map('regex_replace', '^.*- NFS shares currently mounted:\\s*', '')
      | map('regex_findall', '- ([^ ]+)') | flatten
      | list }}"
  when: not leapp_report_missing | default(false)
  block:
    - name: leapp_nfs_detected | End execution of playbook if no entry found in leapp report
      ansible.builtin.debug:
        msg: "No matching entry found in leapp report. Skipping this task."
      when: leapp_inhibitor_summary | length == 0 or split_summary | length == 0

    - name: leapp_nfs_detected | Process remediation
      when:
        - leapp_inhibitor_summary | length > 0
        - split_summary | length > 0
      block:
        - name: leapp_nfs_detected | Comment NFS shares in /etc/fstab
          loop: "{{ fstab_entries }}"
          ansible.builtin.shell: |
            set -o pipefail
            entry="{{ item }}"
            grep -qF "$entry" /etc/fstab && sed -i "s|^$entry|# $entry|" /etc/fstab
          when: fstab_entries | length > 0
          changed_when: fstab_entries | length > 0

        - name: leapp_nfs_detected | Unmount NFS Mounts
          ansible.builtin.command: umount -l {{ item | quote }}
          loop: "{{ nfs_mounts }}"
          when: nfs_mounts | length > 0
          changed_when: nfs_mounts | length > 0

...

---
# Common upgrade test tasks that can be included in any upgrade test

- name: common_upgrade_tasks | Run first analysis
  ansible.builtin.include_role:
    name: infra.leapp.analysis

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Show all inhibitors collected by analysis
  ansible.builtin.debug:
    var: leapp_inhibitors

- name: common_upgrade_tasks | Extract inhibitor titles
  ansible.builtin.set_fact:
    inhibitor_titles: "{{ (leapp_inhibitors | default([])) | map(attribute='title') | list }}"

- name: common_upgrade_tasks | Initialize remediation_todo
  ansible.builtin.set_fact:
    remediation_todo: []

- name: common_upgrade_tasks | Map inhibitors to remediation_todo
  ansible.builtin.set_fact:
    remediation_todo: "{{ remediation_todo + [title_map[map_key]] }}"
  loop: "{{ inhibitor_titles }}"
  loop_control:
    loop_var: inhibitor_title
  vars:
    map_key: "{{ title_map.keys() | select('in', inhibitor_title) | first | default('') }}"
  when: map_key != ''

- name: common_upgrade_tasks | Debug remediation_todo
  ansible.builtin.debug:
    var: remediation_todo

- name: common_upgrade_tasks | Run remediation
  ansible.builtin.include_role:
    name: infra.leapp.remediate

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Reinstall linux-firmware via dnf (remove)
  ansible.builtin.command: dnf remove -y linux-firmware
  changed_when: false

- name: common_upgrade_tasks | Reinstall linux-firmware via dnf (install)
  ansible.builtin.command: dnf install -y linux-firmware
  changed_when: false

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Run analysis after remediation
  ansible.builtin.include_role:
    name: infra.leapp.analysis

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Run upgrade role
  ansible.builtin.include_role:
    name: infra.leapp.upgrade
...

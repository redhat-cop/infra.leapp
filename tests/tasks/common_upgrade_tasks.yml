---
# Common upgrade test tasks that can be included in any upgrade test
# TODO: This is a hack to remove leapp packages before each test to ensure role will install it.
# This is usually due to the fact that we are not using the right repository for the test, which
# causes e.g. rhel 8 packages to have a later N-V-R than rhel 9 packages.
- name: common_upgrade_tasks | Remove leapp packages
  ansible.builtin.package:
    name: "{{ leapp_remove_test_packages }}"
    state: absent

- name: common_upgrade_tasks | Gather setup tasks
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/tasks/setup"
    patterns: "*.yml"
  register: setup_tasks
  delegate_to: localhost

- name: common_upgrade_tasks | Do setup tasks
  ansible.builtin.include_tasks: "{{ setup_task_file }}"
  loop: "{{ setup_task_files }}"
  loop_control:
    loop_var: setup_task_file
  vars:
    setup_task_files: "{{ setup_tasks.files | map(attribute='path') | reject('search', reject_pattern) | list }}"
    reject_pattern: "{{ '/remediate_' if not leapp_test_remediations | d(false) else 'NOMATCH' }}"
  when: setup_task_files | length > 0

- name: common_upgrade_tasks | Run first analysis
  ansible.builtin.include_role:
    name: infra.leapp.analysis

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Show all inhibitors collected by analysis
  ansible.builtin.debug:
    var: leapp_inhibitors | default([])

- name: common_upgrade_tasks | Extract inhibitor titles
  ansible.builtin.set_fact:
    inhibitor_titles: "{{ (leapp_inhibitors | default([])) | map(attribute='title') | list }}"

- name: common_upgrade_tasks | Initialize remediation_todo
  ansible.builtin.set_fact:
    leapp_remediation_todo: []

- name: common_upgrade_tasks | Map inhibitors to remediation_todo
  ansible.builtin.set_fact:
    leapp_remediation_todo: "{{ leapp_remediation_todo | default([]) + [title_map[map_key]] }}"
  loop: "{{ inhibitor_titles }}"
  loop_control:
    loop_var: inhibitor_title
  vars:
    map_key: "{{ title_map.keys() | select('in', inhibitor_title) | first | default('') }}"
  when: map_key != ''

- name: common_upgrade_tasks | Debug remediation_todo
  ansible.builtin.debug:
    var: leapp_remediation_todo

- name: common_upgrade_tasks | Run remediation
  ansible.builtin.include_role:
    name: infra.leapp.remediate

- name: common_upgrade_tasks | Gather verify remediation tasks
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/tasks/verify"
    patterns: "remediate_*.yml"
  when: leapp_test_remediations | d(false)
  register: verify_remediation_tasks
  delegate_to: localhost

- name: common_upgrade_tasks | Verify remediations
  ansible.builtin.include_tasks: "{{ verify_remediation_task_file }}"
  loop: "{{ verify_remediation_tasks.files | map(attribute='path') | list }}"
  loop_control:
    loop_var: verify_remediation_task_file
  when: leapp_test_remediations | d(false)

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

- name: common_upgrade_tasks | Run analysis after remediation
  ansible.builtin.include_role:
    name: infra.leapp.analysis

- name: common_upgrade_tasks | Flush handlers
  ansible.builtin.meta: flush_handlers

# set leapp_test_upgrade to false in order to test only analysis and remediation
- name: common_upgrade_tasks | Run upgrade role
  ansible.builtin.include_role:
    name: infra.leapp.upgrade
  when: leapp_test_upgrade | d(true)
  tags:
    - tests::upgrade
...

---
- name: Test RHEL 7 to 8 Custom Repository Upgrade
  hosts: all
  vars_files:
    - vars/common_upgrade_vars.yml
    - vars/repo_urls.yml
  vars:
    leapp_upgrade_type: custom
    leapp_upgrade_opts: "--no-rhsm"
    local_repos_leapp:
      - name: rhel-8-for-x86_64-baseos-rpms
        description: BaseOS for x86_64
        baseurl: "{{ repo_urls.rhel8.baseos.url }}"
        state: present
      - name: rhel-8-for-x86_64-appstream-rpms
        description: AppStream for x86_64
        baseurl: "{{ repo_urls.rhel8.appstream.url }}"
        state: present
    title_map: "{{ common_title_map }}"
    leapp_answerfile: "{{ common_leapp_answerfile }}"
    # This repo is created in prepare phase in plans/test_playbooks.fmf
    repo_files_to_remove_at_upgrade:
      - rhel7.repo
  tasks:
    - name: Test | Run upgrade 7to8
      block:
        - name: Check if leapp upgrade log exists
          ansible.builtin.stat:
            path: /var/log/leapp/leapp-upgrade.log
          register: leapp_log_stat

        - name: Skip test if not RHEL 7 or already upgraded
          when: >-
              ansible_distribution not in ['CentOS', 'RedHat']
              or ansible_distribution_major_version != "7"
              or leapp_upgrade_completed is defined
              or leapp_log_stat.stat.exists
          ansible.builtin.meta: end_play

        - name: Include common upgrade tasks
          ansible.builtin.include_tasks: tasks/common_upgrade_tasks.yml

        - name: Assert that the system has been upgraded to RHEL 8
          ansible.builtin.assert:
            that:
              - ansible_distribution in ['CentOS', 'RedHat']
              - ansible_distribution_major_version == "8"
            fail_msg: "System was not upgraded to RHEL 8. Current OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
            success_msg: "System successfully upgraded to RHEL 8"

        - name: Mark upgrade as completed
          ansible.builtin.set_fact:
            leapp_upgrade_completed: true

        - name: Move RHEL repositories to /etc/yum.repos.d/
          ansible.builtin.command: >-
            mv /etc/leapp/files/leapp_upgrade_repositories.repo
            /etc/yum.repos.d/rhel8.repo
          changed_when: true
      always:
        - name: Cleanup | Remove log files
          tags: tests::cleanup
          ansible.builtin.shell:
            executable: /bin/bash
            cmd: |
              set -euxo pipefail
              rm -f /var/log/leapp/leapp-upgrade.log
              rm -f /var/log/ripu/ripu.log*
          changed_when: true
...
